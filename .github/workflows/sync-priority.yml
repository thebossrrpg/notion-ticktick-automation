name: Sync Notion Priority to TickTick

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-priority
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore cache.json
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: cache.json
          key: notion-ticktick-cache-
          restore-keys: |
            notion-ticktick-cache-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd src
          npm install @notionhq/client axios

      - name: Run sync script
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          TICKTICKACCESSTOKEN: ${{ secrets.TICKTICKACCESSTOKEN }}
          TICKTICK_LIST_PRIORITY_0: ${{ secrets.TICKTICK_LIST_PRIORITY_0 }}
          TICKTICK_LIST_PRIORITY_1: ${{ secrets.TICKTICK_LIST_PRIORITY_1 }}
          TICKTICK_LIST_PRIORITY_2: ${{ secrets.TICKTICK_LIST_PRIORITY_2 }}
          TICKTICK_LIST_PRIORITY_3: ${{ secrets.TICKTICK_LIST_PRIORITY_3 }}
          TICKTICK_LIST_PRIORITY_4: ${{ secrets.TICKTICK_LIST_PRIORITY_4 }}
          TICKTICK_LIST_PRIORITY_5: ${{ secrets.TICKTICK_LIST_PRIORITY_5 }}
          INITIAL_SYNC_DONE: ${{ secrets.INITIAL_SYNC_DONE }}
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          node src/sync.js

      # ----------------------------
      # Publish analyzer_notionsync.json (GitHub Pages via gh-pages)
      # ----------------------------
      - name: Locate analyzer_notionsync.json
        run: |
          set -e
          if [ -f "analyzer_notionsync.json" ]; then
            echo "FOUND_PATH=analyzer_notionsync.json" >> $GITHUB_ENV
          elif [ -f "src/analyzer_notionsync.json" ]; then
            echo "FOUND_PATH=src/analyzer_notionsync.json" >> $GITHUB_ENV
          else
            echo "ERROR: analyzer_notionsync.json not found (checked ./analyzer_notionsync.json and ./src/analyzer_notionsync.json)"
            echo "TIP: make sure src/sync.js writes analyzer_notionsync.json to one of these locations."
            exit 1
          fi

      - name: Validate analyzer_notionsync.json
        run: |
          set -e
          node -e "const fs=require('fs'); const p=process.env.FOUND_PATH; const raw=fs.readFileSync(p,'utf8'); JSON.parse(raw); console.log('JSON OK:', p, 'bytes=', raw.length);"

      - name: Prepare publish dir
        run: |
          set -e
          rm -rf .publish
          mkdir -p .publish
          cp "${FOUND_PATH}" .publish/analyzer_notionsync.json
          echo "OK" > .publish/health.txt

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .publish
          force_orphan: true

      - name: Save cache.json
        if: always()
        uses: actions/cache/save@v4
        with:
          path: cache.json
          key: notion-ticktick-cache-${{ github.run_number }}
